<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title></title>
<link rel="stylesheet" type="text/css" href="styles/style.css" />
</head>

<body>

<div class="wrapper">

<div class="index">
<ol>
<li><a href="chapter01_hello-world.html">&quot;hello world&quot;（创建JeCat项目）</a></li>
<li><a href="chapter02_file-operation.html">文件操作</a></li>
<li><a href="chapter03_use-ui-engine.html">HTML模板</a></li>
<li><a href='chapter04.html'>MVC模式：控件类</a> 
	<ul>
		<li><a href='chapter04part00_pre.html'>准备工作</a></li>
		<li><a href='chapter04part01_use-Text.html'>使用Text类</a></li>
		<li><a href='chapter04part02_process.html'>获取表单提交数据</a></li>
		<li><a href='chapter04part03_use-Group.html'>使用Group类</a></li>
		<li><a href='chapter04part04_use-CheckBtn.html'>使用CheckBtn类</a></li>
		<li><a href='chapter04part05_use-Select.html'>使用Select和SelectList类</a></li>
		<li><a href='chapter04part06_use-File.html'>使用File类</a></li>
		<li><a href='chapter04part07_finish.html'>总结</a></li>
	</ul>
</li>
<li><a href='chapter05.html'>MVC模式：模型（model）</a>
	<ul>
		<li><a href='chapter05part00_pre.html'>准备工作</a></li>
		<li><a href='chapter05part01_method1.html'>直接了当的方式</a></li>
		<li><a href='chapter05part02_method2.html'>聪明的方式</a></li>
		<li><a href='chapter05part03_method3.html'>完整的定义orm</a></li>
	</ul>
</li>
<li> MVC模式：数据交换</li>
<li> MVC模式：使用控制器（controller）</li>
<li> MVC模式：控制器和视图的组合/重用</li>
<li> 数据校验</li>
<li> 消息队列</li>
</ol> 
</div>

<div class="bodyText">
<div>
	<h1><span class="title"></span>完整的定义orm</h1>
	<p>上一节的代码从软件工程的质量标准来看，有一处很不理想的瑕疵：每次创建Model对象时，都需要临时定义一个ORM配置，可是涉及到相同的数据表时，那些ORM信息就会被反复定义。这违背了“Dont repeat your self”原则。</p>
	<p>JeCat框架推荐一种更理想的方式来维护ORM配置：将所有的数据表及其关联都集中定义在一个地方，这些定义就形成了一张表与表之间的关系图。创建Model对象时，就只需要从完整的“关系图”中截取一个所需的“片段”即可。
	</p>
	<h3 id='s1'>step 1.</h3>
	<div class='step'>
		<p class='purpose'>在文件 MyProject/model_common.php 的开头加入</p>
				<pre class='code'>
			<code class='php'>
use jc\mvc\model\db\orm\PrototypeAssociationMap ;</code>
				</pre>
		<p>我们需要向项目引入 PrototypeAssociationMap 类，这个类负责统一维护一个完整的数据表关系网。然后在 MyProject/model_common.php 中继续添加以下代码：</p>
			<pre class='code'>
			<code class='php'>
$aPam = PrototypeAssociationMap::singleton() ;

// 定义 categories 数据表原型
$aPam->add(
	array(
		'name' => 'category' ,			// 数据表原型名称
		'table' => 'categories' ,		// 数据表名称
		
		// 定义这个数据表所拥有的 hasMany 关联
		'hasMany' => array(
			array(
				'prop' => 'books' ,		// book 对象在 category 对象内的属性名称
				'tok' => 'category' ,	// 关键另一端的字段
			
				// 被关联的数据表原型
				'prototype' => 'book' ,	// books 表的原型名称
			) ,
	
		) ,
	)
) ;

// 定义 books 数据表原型
$aPam->add(
	array(
		'name' => 'book' ,				// 数据表原型名称
		'table' => 'books' ,			// 数据表名称
	
		// 定义这个数据表所拥有的 hasMany 关联
		'belongsTo' => array(
			array(
				'prop' => 'press' ,
				'fromk' => 'press' ,	// 外键的字段名
				// 被关联的表
				'prototype' => 'press' ,// 为 presses 表定义的原型名称
			) ,
		) ,
		
		// 定义这个数据表所拥有的 hasMany 关联
		'hasAndBelongsToMany' => array(
			'prop' => 'authors' ,
			'bridge' => 'authors' ,		// “桥接表”
			// 被关联的表
			'prototype' => 'users' ,
		) ,
	)
) ;

// 定义 presses 数据表原型
$aPam->add(
	array(
		'name' => 'press' ,			// 数据表原型名称
		'table' => 'presses' ,		// 数据表名称
	)
) ;

// 定义 categories 数据表原型
$aPam->add(
	array(
		'name' => 'user' ,			// 数据表原型名称
		'table' => 'users' ,		// 数据表名称
	)
) ;</code>
				</pre>
	</div>
	<h3 id='s2'>step 2.</h3>
	<div class='step'>
		<p class='purpose'>我们已经在 MyProject/model_common.php 文件中定义了所有需要用到的数据表及其关联，然后在  MyProject/model_example.php 文件中加入使用这些定义来创建Model对象的代码：</p>
		<pre class='code'>
				<code class='php'>
// 使用 book原型，及其 authors 和 press 关联
$aBook = Model::fromFragment('book',array('authors','press')) ;


// 使用 category原型，及其 books关联，并且递归使用book中的 authors 和 press 关联
$aBook = Model::fromFragment('category',array( 'books' => array('authors','press') ) ) ;</code>
</pre>
		<p>向PrototypeAssociationMap 类的单件实例中一次性添加整个系统所需要的数据表原型定义，然后就可以通过上面演示的方式，从中取出片段，并根据这些关系片段来创建Model对象。</p>
	</div>
	<blockquote class="prepare">
		向PrototypeAssociationMap 对象 add orm配置时，关联的 'prototype' 元素不再需要提供另一个数据表原型的完整定义，只要提供数据表原型的名称即可。
	</blockquote>
	
</div>
</div>

</div>
<script src='scripts/jquery-1.6.2.min.js' type='text/javascript'></script>
<script src='scripts/jquery.beautyOfCode-min.js' type='text/javascript'></script>
<script type="text/javascript">
$(function(){
	$.beautyOfCode.init({
		brushes: ['Xml', 'JScript', 'CSharp', 'Plain', 'Php' ,'Sql'],
		baseUrl: 'http://'+location.hostname+'/doc/tutorial/html/',
		ready: function() {
			$.beautyOfCode.beautifyAll();
		}
	});
});
</script>
</body>
</html>